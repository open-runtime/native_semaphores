# Generated by runtime_ci_tooling v0.13.0
# Configured via .runtime_ci/config.json — run 'dart run runtime_ci_tooling:manage_cicd update --workflows' to regenerate.
name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  pre-check:
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.bot_check.outputs.should_run }}
    steps:
      - uses: actions/checkout@v6.0.2
        with:
          fetch-depth: 1
          persist-credentials: false

      - name: Check for bot commit
        id: bot_check
        run: |
          AUTHOR=$(git log -1 --format='%an')
          MSG=$(git log -1 --format='%s')
          echo "Commit author: $AUTHOR"
          echo "Commit subject: $MSG"
          if [[ "$AUTHOR" == "github-actions[bot]" ]] || [[ "$MSG" == *"[skip ci]"* ]] || [[ "$MSG" == "bot(format)"* ]]; then
            echo "should_run=false" >> "$GITHUB_OUTPUT"
            echo "::notice::Bot commit detected — skipping CI."
          else
            echo "should_run=true" >> "$GITHUB_OUTPUT"
          fi

  auto-format:
    needs: pre-check
    if: needs.pre-check.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      sha: ${{ steps.format-push.outputs.sha || github.sha }}
    steps:
      - uses: actions/checkout@v6.0.2
        with:
          ref: ${{ github.head_ref || github.ref }}
          token: ${{ secrets.TSAVO_AT_PIECES_PERSONAL_ACCESS_TOKEN || github.token }}
          persist-credentials: true

      - uses: dart-lang/setup-dart@v1.7.1
        with:
          sdk: "3.9.2"

      - name: Format code
        run: dart format --line-length 120 lib/

      - name: Commit and push formatting
        id: format-push
        run: |
          if ! git diff --quiet; then
            git config user.name "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git add -A
            git commit -m "bot(format): apply dart format --line-length 120 [skip ci]"
            if git push; then
              echo "sha=$(git rev-parse HEAD)" >> "$GITHUB_OUTPUT"
              echo "::notice::Formatting changes committed and pushed."
            else
              echo "::warning::Could not push formatting changes (branch may be protected or this is a fork PR)."
            fi
          else
            echo "::notice::Code is already formatted."
          fi

  analyze:
    needs: [pre-check, auto-format]
    if: needs.pre-check.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6.0.2
        with:
          ref: ${{ needs.auto-format.outputs.sha }}
          persist-credentials: false

      - name: Configure Git for HTTPS with Token
        shell: bash
        run: |
          TOKEN="${{ secrets.TSAVO_AT_PIECES_PERSONAL_ACCESS_TOKEN || secrets.GITHUB_TOKEN }}"
          git config --global url."https://x-access-token:${TOKEN}@github.com/".insteadOf "git@github.com:"
          git config --global url."https://x-access-token:${TOKEN}@github.com/".insteadOf "ssh://git@github.com/"
          git config --global url."https://x-access-token:${TOKEN}@github.com/open-runtime/".insteadOf "git@github.com:open-runtime/"
          git config --global url."https://x-access-token:${TOKEN}@github.com/pieces-app/".insteadOf "git@github.com:pieces-app/"

      - uses: dart-lang/setup-dart@v1.7.1
        with:
          sdk: "3.9.2"

      - name: Cache Dart pub dependencies
        uses: actions/cache@v5.0.3
        with:
          path: ~/.pub-cache
          key: ${{ runner.os }}-${{ runner.arch }}-dart-pub-${{ hashFiles('**/pubspec.yaml') }}
          restore-keys: ${{ runner.os }}-${{ runner.arch }}-dart-pub-

      - run: dart pub get
        env:
          GIT_LFS_SKIP_SMUDGE: "1"

      - name: Analyze
        run: |
          dart analyze 2>&1 | tee /tmp/analysis.txt
          if grep -q "^  error -" /tmp/analysis.txt; then
            echo "::error::Analysis errors found"
            exit 1
          fi

  test:
    needs: [pre-check, analyze, auto-format]
    if: needs.pre-check.outputs.should_run == 'true'
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include: [{"platform_id":"ubuntu-x64","runner":"runtime-ubuntu-24.04-x64-256gb-64core","os_family":"linux","arch":"x64"},{"platform_id":"ubuntu-arm64","runner":"runtime-ubuntu-24.04-arm64-208gb-64core","os_family":"linux","arch":"arm64"},{"platform_id":"macos-arm64","runner":"macos-latest","os_family":"macos","arch":"arm64"},{"platform_id":"macos-x64","runner":"macos-15-intel","os_family":"macos","arch":"x64"},{"platform_id":"windows-x64","runner":"runtime-windows-2025-x64-256gb-64core","os_family":"windows","arch":"x64"},{"platform_id":"windows-arm64","runner":"runtime-windows-11-arm64-208gb-64core","os_family":"windows","arch":"arm64"}]
    steps:
      - uses: actions/checkout@v6.0.2
        with:
          ref: ${{ needs.auto-format.outputs.sha }}
          persist-credentials: false

      - name: Configure Git for HTTPS with Token
        shell: bash
        run: |
          TOKEN="${{ secrets.TSAVO_AT_PIECES_PERSONAL_ACCESS_TOKEN || secrets.GITHUB_TOKEN }}"
          git config --global url."https://x-access-token:${TOKEN}@github.com/".insteadOf "git@github.com:"
          git config --global url."https://x-access-token:${TOKEN}@github.com/".insteadOf "ssh://git@github.com/"
          git config --global url."https://x-access-token:${TOKEN}@github.com/open-runtime/".insteadOf "git@github.com:open-runtime/"
          git config --global url."https://x-access-token:${TOKEN}@github.com/pieces-app/".insteadOf "git@github.com:pieces-app/"

      - uses: dart-lang/setup-dart@v1.7.1
        with:
          sdk: "3.9.2"

      - name: Cache Dart pub dependencies
        uses: actions/cache@v5.0.3
        with:
          path: ~/.pub-cache
          key: ${{ runner.os }}-${{ runner.arch }}-dart-pub-${{ hashFiles('**/pubspec.yaml') }}
          restore-keys: ${{ runner.os }}-${{ runner.arch }}-dart-pub-

      - run: dart pub get
        env:
          GIT_LFS_SKIP_SMUDGE: "1"

# --- BEGIN USER: pre-test ---
# --- END USER: pre-test ---

      - name: Test
        run: dart test

# --- BEGIN USER: post-test ---
# --- END USER: post-test ---

# --- BEGIN USER: extra-jobs ---
# --- END USER: extra-jobs ---
